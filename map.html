<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Akıllı Rota Asistanı - Harita</title>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDppQCusNzyEVBq4mgINSwQuu6gXjRQlwI&libraries=places"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDppQCusNzyEVBq4mgINSwQuu6gXjRQlwI&libraries=geometry,places"></script>
  <script src="fonts/Roboto-Regular.js"></script>


  
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
  margin: 0;
  padding: 0;
  font-family: "Segoe UI", sans-serif;
  background: linear-gradient(to bottom right, #e0f7fa, #fefcea);
  color: #222;
  min-height: 100vh;
  background-attachment: fixed;
  background-repeat: no-repeat;
  background-size: cover;
}


    .container {
      max-width: 1000px;
      margin: 2rem auto;
      padding: 1rem;
      background-color: white;
      border-radius: 12px;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }

    h1 {
      text-align: center;
      margin-bottom: 1rem;
      color: #2c3e50;
    }

    #map {
      height: 500px;
      width: 100%;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease-in-out;
    }

    .info-box {
      margin-top: 1.5rem;
      background-color: #f9fafb;
      padding: 1rem 1.5rem;
      border-left: 5px solid #3498db;
      border-radius: 8px;
      box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.05);
      font-size: 1.1rem;
    }

    .buttons {
      display: flex;
      gap: 1rem;
      margin-top: 1.5rem;
      flex-wrap: wrap;
    }

    .buttons button {
      flex: 1;
      padding: 0.75rem;
      font-size: 1rem;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .buttons button:hover {
      background-color: #2980b9;
    }

    .alt-options {
      display: none;
      margin-top: 1rem;
      gap: 1rem;
    }

    .alt-options button {
      flex: 1;
      padding: 0.5rem;
      font-size: 1rem;
      border: 2px solid #3498db;
      background-color: white;
      color: #3498db;
      border-radius: 6px;
      cursor: pointer;
    }

    .alt-options button:hover {
      background-color: #3498db;
      color: white;
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      font-size: 1.5rem;
      color: #2c3e50;
      font-weight: bold;
    }

    @media (max-width: 600px) {
      .container {
        margin: 1rem;
        padding: 1rem;
      }
      #map {
        height: 400px;
      }
      .buttons, .alt-options {
        flex-direction: column;
      }
    }
    .pdf-share {
  display: flex;
  justify-content: center;
  gap: 1rem;
  margin: 20px auto;
  padding: 10px;
  max-width: 500px;
  border-radius: 12px;
  background: linear-gradient(135deg, #f0f8ff, #dbeeff);
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.pdf-share button {
  flex: 1;
  padding: 10px 16px;
  font-size: 16px;
  font-weight: bold;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: transform 0.2s ease, background-color 0.3s ease;
}

.pdf-share .pdf-btn {
  background-color: #1abc9c;
  color: white;
}

.pdf-share .pdf-btn:hover {
  background-color: #16a085;
  transform: scale(1.05);
}

.pdf-share .share-btn {
  background-color: #3498db;
  color: white;
}

.pdf-share .share-btn:hover {
  background-color: #2980b9;
  transform: scale(1.05);
}

  </style>
</head>
<body>
  
  <div class="pdf-share">
    <button class="pdf-btn" onclick="downloadPDF()">📄 PDF İndir</button>
    <button class="share-btn" onclick="navigator.clipboard.writeText(window.location.href);alert('🔗 Bağlantı kopyalandı!')">🔗 Bağlantıyı Paylaş</button>
  </div>
  
  <div id="speed-box" style="
  position: absolute;
  top: 80px;
  right: 30px;
  background: #fff;
  padding: 10px 15px;
  border-radius: 8px;
  box-shadow: 0 0 10px rgba(0,0,0,0.2);
  font-weight: bold;
  z-index: 1000;">
  🚗 Hız: <span id="speed-value">--</span> km/s
</div>

  <div class="loading-overlay" id="loading">Rota hesaplanıyor...</div>
  <div class="container">
    <h1>Akıllı Rota Asistanı - Rota Haritası</h1>
   
<div id="progress-container" style="
  position: absolute;
  top: 10px;
  left: 50%;
  transform: translateX(-50%);
  width: 80%;
  height: 20px;
  background: #ddd;
  border-radius: 10px;
  overflow: hidden;
  z-index: 1000;
  box-shadow: 0 0 6px rgba(0,0,0,0.2);">
  
  <div id="progress-bar" style="
    height: 100%;
    width: 0%;
    background: linear-gradient(to right, #4CAF50, #2196F3);
    transition: width 0.4s ease;">
  </div>

  <span id="progress-text" style="
    position: absolute;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    font-size: 12px;
    font-weight: bold;
    color: white;
    line-height: 20px;">
    %0 tamamlandı
  </span>
</div>


    <div id="map"></div>
   <div class="info-box" id="route-info"></div>
    <div class="buttons">
      <button onclick="window.location.href='index.html'">Yeniden Rota Hesapla</button>
      <button  onclick="showRouteDetails()">Güzergahları Göster</button>
      <button onclick="loadAlternatives()">Alternatif Rotaları Göster</button>
    <button id="show-route-info">🧭 Güzergahı Göster</button></div>
    <div class="alt-options" id="alt-options"></div>
  </div>
 
 
  
    
  <script>
    let globalRouteData = null;
    let directionsRenderer;
    let allRoutes = [];

    function getQueryParams() {
      const params = new URLSearchParams(window.location.search);
      const start = params.get("start");
      const end = params.get("end");
      const stops = [];
      for (const [key, value] of params.entries()) {
        if (key.startsWith("stop")) stops.push(value);
      }
      return { start, stops, end };
    }

    function showRouteDetails() {
      if (!globalRouteData) return;
      const { start, stops, end } = globalRouteData;
      let detailText = `<strong>Başlangıç:</strong> ${start}<br>`;
      stops.forEach((s, i) => {
        detailText += `<strong>Durak ${i + 1}:</strong> ${s}<br>`;
      });
      detailText += `<strong>Bitiş:</strong> ${end}`;
      document.getElementById('route-info').innerHTML += `<br><br><strong>Güzergah Detayları:</strong><br>${detailText}`;
    }

    function loadAlternatives() {
  const altDiv = document.getElementById("alt-options");
  altDiv.innerHTML = '';
  altDiv.style.display = 'flex';
  if (!globalRouteData) return;

  const { start, stops, end } = globalRouteData;
  const directionsService = new google.maps.DirectionsService();

  directionsService.route(
    {
      origin: start,
      destination: end,
      waypoints: stops.map(s => ({ location: s, stopover: true })),
      travelMode: google.maps.TravelMode.DRIVING,
      provideRouteAlternatives: true
    },
    (response, status) => {
      if (status === "OK") {
        allRoutes = response.routes;
        altDiv.innerHTML = '';

        const vehicleClass = new URLSearchParams(window.location.search).get('vehicle') || '1';
        const fuelRates = {
          '1': 2.90, '2': 3.87, '3': 4.84, '4': 7.26, '5': 5.82, '6': 1.45
        };
        const rate = fuelRates[vehicleClass] || 2.90;

        allRoutes.forEach((route, i) => {
          const totalDistance = route.legs.reduce((sum, leg) => sum + leg.distance.value, 0);
          const totalDuration = route.legs.reduce((sum, leg) => sum + leg.duration.value, 0);
          const km = (totalDistance / 1000).toFixed(1);
          const mins = Math.round(totalDuration / 60);
          const yakit = (km * rate).toFixed(2);

          const btn = document.createElement('button');
          btn.innerHTML = `${i === 0 ? '🚀 Hızlı' : i === 1 ? '💰 Ekonomik' : '🧠 Akıllı'} Rota<br>${km} km - ${mins} dk<br>⛽ ₺${yakit}`;
          btn.onclick = () => {
            renderRoute(i);
            updateLocalRouteData(km, mins, yakit);
            document.getElementById('route-info').innerHTML = `
              <strong>Seçilen Alternatif Rota</strong><br>
              Mesafe: ${km} km<br>
              Süre: ${mins} dakika<br>
              Yakıt: ₺${yakit}
            `;
          };
          altDiv.appendChild(btn);
        });

        // 🔁 Ana rotaya geri dön butonu
        const backBtn = document.createElement('button');
        backBtn.innerHTML = '🔙 Ana Rota';
        backBtn.onclick = () => {
          renderRoute(0);
          const mainRoute = allRoutes[0];
          const totalDistance = mainRoute.legs.reduce((sum, leg) => sum + leg.distance.value, 0);
          const totalDuration = mainRoute.legs.reduce((sum, leg) => sum + leg.duration.value, 0);
          const km = (totalDistance / 1000).toFixed(1);
          const mins = Math.round(totalDuration / 60);
          const yakit = (km * rate).toFixed(2);

          updateLocalRouteData(km, mins, yakit);
          document.getElementById('route-info').innerHTML = `
            <strong>Ana Rota</strong><br>
            Mesafe: ${km} km<br>
            Süre: ${mins} dakika<br>
            Yakıt: ₺${yakit}
          `;
        };
        altDiv.appendChild(backBtn);
      } else {
        alert("Alternatif rota bulunamadı: " + status);
      }
    }
  );
}

    function renderRoute(index) {
  // Aynı rota tekrar çiziliyor
  directionsRenderer.setRouteIndex(index);

  const selectedPolyline = allRoutes[index].overview_polyline?.points;

  // En iyi rota kontrolü: diğer rotaların polyline'ı ile karşılaştır
  let isDuplicate = false;
  for (let i = 0; i < allRoutes.length; i++) {
    if (i !== index && allRoutes[i].overview_polyline?.points === selectedPolyline) {
      isDuplicate = true;
      break;
    }
  }

  if (isDuplicate) {
    alert("🚨 Bu yol zaten en iyi yol! Diğer alternatifle tamamen aynı güzergah.");
  }
}

function initMap() {
  const { start, stops, end } = getQueryParams();
  globalRouteData = { start, stops, end };

  window.map = new google.maps.Map(document.getElementById("map"), {
  zoom: 7,
  center: { lat: 39.92, lng: 32.85 },
  disableDefaultUI: false,
  zoomControl: true
});
const trafficLayer = new google.maps.TrafficLayer();
trafficLayer.setMap(window.map);


  const directionsService = new google.maps.DirectionsService();
  directionsRenderer = new google.maps.DirectionsRenderer({ suppressMarkers: false });
  directionsRenderer.setMap(map);

  const waypoints = stops.map(loc => ({ location: loc, stopover: true }));

  let routePolyline = null;
  directionsService.route(
    {
      origin: start,
      destination: end,
      waypoints: waypoints,
      optimizeWaypoints: true,
      travelMode: google.maps.TravelMode.DRIVING, 
      drivingOptions: {
    departureTime: new Date(),      // şu anki zaman
    trafficModel: 'bestguess'       // trafik yoğunluğu tahmini
  },
  provideRouteAlternatives: true
  
    },

    (response, status) => {
      const loading = document.getElementById('loading');
      const infoBox = document.getElementById('route-info');

      if (status === "OK") {
        directionsRenderer.setDirections(response);
        window.directionsResult = response;
        loading.style.display = 'none';

        const route = response.routes[0];
    const path = google.maps.geometry.encoding.decodePath(route.overview_polyline.points);
  routePolyline = new google.maps.Polyline({
    path,
    strokeColor: "#1E90FF",
    strokeOpacity: 0.9,
    strokeWeight: 6,
    map: window.map
  });
        let totalDistance = 0;
        let totalDuration = 0;
        let totalTrafficDuration = 0;
        route.legs.forEach(leg => {
          totalDistance += leg.distance.value;
          totalDuration += leg.duration.value;
          if (leg.duration_in_traffic) {
    totalTrafficDuration += leg.duration_in_traffic.value;
  } else {
    totalTrafficDuration += leg.duration.value; // fallback
  }
        });

        const km = parseFloat((totalDistance / 1000).toFixed(1));

        const mins = Math.round(totalDuration / 60);

        infoBox.innerHTML = `<strong>Toplam Mesafe:</strong> ${km} km<br><strong>Tahmini Süre:</strong> ${mins} dakika`;

        const vehicleClass = new URLSearchParams(window.location.search).get('vehicle') || '1';
        const fuelRates = {
          '1': 2.90, '2': 3.87, '3': 4.84, '4': 7.26, '5': 5.82, '6': 1.45
        };
        const rate = fuelRates[vehicleClass] || 2.90;
        const yakitMaliyeti = (km * rate).toFixed(2);

        infoBox.innerHTML += `<br><strong>Yakıt Maliyeti:</strong> ₺${yakitMaliyeti}`;

        // 🔊 SESLİ TARİF
        const steps = route.legs.flatMap(leg => leg.steps);
        let delay = 0;
        steps.forEach(step => {
          const instruction = step.instructions.replace(/<[^>]+>/g, '');
          setTimeout(() => {
            const utterance = new SpeechSynthesisUtterance(instruction);
            utterance.lang = 'tr-TR';
            speechSynthesis.speak(utterance);
          }, delay);
          delay += (step.duration.value * 1000);
        });

        // 🟢 ROTAYA BAŞLA BUTONU ÇALIŞTIRICISI
        document.getElementById("start-navigation-btn").addEventListener("click", () => {
  if (navigator.geolocation) {
    navigator.geolocation.watchPosition(
      (pos) => {
        const { latitude, longitude } = pos.coords;
        const userLatLng = new google.maps.LatLng(latitude, longitude);

        if (!window.userMarker) {
          window.userMarker = new google.maps.Marker({
            position: userLatLng,
            map: window.map,
            icon: {
              url: "https://maps.gstatic.com/mapfiles/ms2/micons/cabs.png",
              scaledSize: new google.maps.Size(40, 40)
            },
            title: "Siz"
          });
        } else {
          window.userMarker.setPosition(userLatLng);
        }

        window.map.panTo(userLatLng);
        window.map.setZoom(16);
      },
      (err) => {
        alert("Konum alınamadı: " + err.message);
      },
      {
        enableHighAccuracy: true,
        maximumAge: 0
      }
    );
  } else {
    alert("Tarayıcınız konum özelliğini desteklemiyor.");
  }
});


      } else {
        loading.innerText = "Rota bulunamadı: " + status;
      }
    }
  );
  // 🔁 SEKME DEĞİŞSE BİLE KONUM GÜNCELLEYEN YAPI
  function konumGuncelle() {

  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const { latitude, longitude } = pos.coords;
        const userLatLng = new google.maps.LatLng(latitude, longitude);

        // ROTA ÜZERİNDEN GEÇİLEN YOLU SİL
       /* if (routePolyline) {
          
          const fullPath = google.maps.geometry.encoding.decodePath(route.overview_polyline.points);
  const remainingPath = routePolyline.getPath().getArray();

  const totalPoints = fullPath.length;
  const remainingPoints = remainingPath.length;

  const percentComplete = Math.round(100 * (1 - (remainingPoints / totalPoints)));

  // Güncelleme
  const progressBar = document.getElementById("progress-bar");
  progressBar.style.width = percentComplete + "%";
  document.getElementById("progress-text").textContent = `%${percentComplete} tamamlandı`;

          const newPath = currentPath.filter((point) => {
            const distance = google.maps.geometry.spherical.computeDistanceBetween(userLatLng, point);
            return distance > 20;
          });
          routePolyline.setPath(newPath);
        }*/

        // HARİTA MARKER VE ODAK
        if (!window.userMarker) {
          window.userMarker = new google.maps.Marker({
            position: userLatLng,
            map: window.map,
            icon: {
              url: "https://maps.gstatic.com/mapfiles/ms2/micons/cabs.png",
              scaledSize: new google.maps.Size(40, 40)
            },
            title: "Siz"
          });
        } else {
          window.userMarker.setPosition(userLatLng);
        }

        window.map.panTo(userLatLng);
        window.map.setZoom(16);
      },
      (err) => console.warn("Konum alınamadı:", err.message),
      { enableHighAccuracy: true }
    );
  } else {
    alert("Tarayıcınız konum desteği sunmuyor.");
  }
}


// ⏱ 5 saniyede bir konum güncelle
setInterval(konumGuncelle, 500);

}
document.getElementById("show-route-info").addEventListener("click", () => {
  if (!window.directionsResult) {
    alert("Lütfen önce bir rota oluşturun.");
    return;
  }

  const route = window.directionsResult.routes[0];

  let totalDistance = 0;
  let totalDuration = 0;

  route.legs.forEach(leg => {
    totalDistance += leg.distance.value;   // metre
    totalDuration += leg.duration.value;   // saniye
  });

  const km = parseFloat((totalDistance / 1000).toFixed(1));
  const mins = Math.round(totalDuration / 60);

  const vehicleClass = new URLSearchParams(window.location.search).get('vehicle') || '1';
  const fuelRates = {
    '1': 2.90, '2': 3.87, '3': 4.84, '4': 7.26, '5': 5.82, '6': 1.45
  };
  const rate = fuelRates[vehicleClass] || 2.90;
  const yakitMaliyeti = (km * rate).toFixed(2);

  // Rota bilgisi kutusuna yaz
  const infoBox = document.getElementById("route-info");
  infoBox.innerHTML = `
  <strong>Toplam Mesafe:</strong> ${km} km<br>
  <strong>Trafikli Süre Tahmini:</strong> ${mins} dakika<br>
  <strong>Yakıt Maliyeti:</strong> ₺${yakitMaliyeti}
`;

});


   
      async function downloadPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  const info = document.getElementById("route-info").innerText;

  // Araç sınıfı parametresini al
  const vehicleClass = new URLSearchParams(window.location.search).get('vehicle') || '1';

  // Araç bilgileri
  const vehicleNames = {
    '1': 'Otomobil',
    '2': 'Minibüs',
    '3': 'Kamyonet',
    '4': 'Kamyon',
    '5': 'Otobüs',
    '6': 'Motosiklet'
  };
  const fuelRates = {
    '1': 2.90,
    '2': 3.87,
    '3': 4.84,
    '4': 7.26,
    '5': 5.82,
    '6': 1.45
  };

  const vehicleName = vehicleNames[vehicleClass] || 'Otomobil';
  const kmRate = fuelRates[vehicleClass] || 2.90;

  // Total KM'yi route-info içinden al (örneğin: "Toplam Mesafe: 20.5 km")
  const kmMatch = info.match(/Toplam Mesafe:\s*([\d.]+) km/);
  const totalKm = kmMatch ? parseFloat(kmMatch[1]) : 0;
  const totalCost = (totalKm * kmRate).toFixed(2);

  const extra = `
Araç Sınıfı: ${vehicleClass} - ${vehicleName}
Km Başına Maliyet: ₺${kmRate.toFixed(2)}
Tahmini Yakıt Maliyeti: ₺${totalCost}
  `;

  // PDF oluştur
  doc.setFontSize(14);
  doc.text("Akıllı Rota Asistanı - Rota Bilgileri", 10, 10);
  doc.setFontSize(11);
  const lines = doc.splitTextToSize(info + '\\n\\n' + extra, 180);
  doc.text(lines, 10, 20);
  doc.save("rota-bilgileri.pdf");
}

if ("geolocation" in navigator) {
  navigator.geolocation.watchPosition(
    (pos) => {
      const speed = pos.coords.speed; // m/s
      const speedKmH = speed >= 0 ? (speed * 3.6).toFixed(1) : '0';
      document.getElementById("speed-value").textContent = speedKmH;
    },
    (err) => {
      console.warn("Hız bilgisi alınamadı:", err.message);
    },
    {
      enableHighAccuracy: true,
      maximumAge: 1000
    }
  );
}


    window.onload = initMap;
  </script>
</body>
</html>